# Diagramas e Fluxogramas - Simulador de Labirinto

## 🏗️ Arquitetura do Sistema

```
┌─────────────────────────────────────────────────────────────────┐
│                        STM32F411 (Black Pill)                    │
│                                                                   │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐    │
│  │   MPU6050    │     │   ST7789     │     │    Button    │    │
│  │    (I2C1)    │     │   (SPI1)     │     │    (GPIO)    │    │
│  │              │     │              │     │              │    │
│  │ • Accel      │     │ • 240x240    │     │ • PA0        │    │
│  │ • Gyro       │     │ • RGB565     │     │ • Reset      │    │
│  └──────┬───────┘     └──────┬───────┘     └──────┬───────┘    │
│         │                    │                    │             │
│  ┌──────▼────────────────────▼────────────────────▼───────┐    │
│  │                     FreeRTOS Kernel                      │    │
│  │                                                          │    │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐       │    │
│  │  │  IMU_Task  │  │ Logic_Task │  │ Display_   │       │    │
│  │  │   (50Hz)   │  │   (50Hz)   │  │   Task     │       │    │
│  │  │            │  │            │  │  (20Hz)    │       │    │
│  │  │ Read IMU   │→→│ Physics    │→→│ Render     │       │    │
│  │  │ → Queue    │  │ Collision  │  │ Graphics   │       │    │
│  │  └────────────┘  │ Game Logic │  └────────────┘       │    │
│  │                  └────────────┘                        │    │
│  │                                                          │    │
│  │  ┌────────────┐                                        │    │
│  │  │Button_Task │  ← Mutex/Queue Communication          │    │
│  │  │   (50Hz)   │                                        │    │
│  │  └────────────┘                                        │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    UART Debug (115200)                    │   │
│  └───────────────────────────────┬──────────────────────────┘   │
└────────────────────────────────────┼──────────────────────────────┘
                                     │
                                     ▼
                              Monitor Serial
```

---

## 🔄 Fluxo Principal do Jogo

```
        ┌─────────────┐
        │   POWER ON  │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │ System Init │
        │ • GPIO      │
        │ • UART      │
        │ • SPI/I2C   │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │Periph Init  │
        │ • ST7789    │
        │ • MPU6050   │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │ Create      │
        │ FreeRTOS    │
        │ Tasks       │
        └──────┬──────┘
               │
               ▼
        ┌─────────────┐
        │  Scheduler  │
        │   Started   │
        └──────┬──────┘
               │
               ▼
┌──────────────────────────────────────┐
│        GAME_INIT State               │
│  • Load Maze                         │
│  • Init Ball Position                │
│  • Reset Lives (3)                   │
│  • Reset Timer                       │
└──────────────┬───────────────────────┘
               │
               ▼
┌──────────────────────────────────────┐
│      GAME_PLAYING State              │
│                                      │
│  ┌────────────────────────┐         │
│  │   Read MPU6050 Data    │         │
│  │    (Tilt Detection)    │         │
│  └───────────┬────────────┘         │
│              │                       │
│              ▼                       │
│  ┌────────────────────────┐         │
│  │   Update Ball Physics  │         │
│  │   • Acceleration       │         │
│  │   • Velocity           │         │
│  │   • Position           │         │
│  └───────────┬────────────┘         │
│              │                       │
│              ▼                       │
│  ┌────────────────────────┐         │
│  │  Check Collisions      │         │
│  │   • Walls              │         │
│  │   • Holes              │         │
│  │   • Goal               │         │
│  └───────────┬────────────┘         │
│              │                       │
│         ┌────┴────┐                 │
│         │         │                 │
│    ┌────▼────┐ ┌──▼──────┐         │
│    │  Hole?  │ │ Goal?   │         │
│    └────┬────┘ └──┬──────┘         │
│         │         │                 │
│     ┌───▼──┐  ┌───▼───┐            │
│     │ YES  │  │  YES  │            │
│     └───┬──┘  └───┬───┘            │
│         │         │                 │
│         │         │                 │
└─────────┼─────────┼─────────────────┘
          │         │
          ▼         ▼
  ┌──────────┐  ┌──────────┐
  │Lives - 1 │  │GAME_WON  │
  └────┬─────┘  │ Save     │
       │        │Best Time │
       │        └────┬─────┘
       ▼             │
  ┌──────────┐      │
  │Lives > 0?│      │
  └────┬─────┘      │
       │            │
   ┌───┴───┐        │
   │       │        │
  YES     NO        │
   │       │        │
   ▼       ▼        │
 RESET  GAME_OVER   │
  TO     ┌──────┐   │
 START   │Wait  │◄──┘
         │Button│
         └───┬──┘
             │
             ▼
        GAME_INIT
         (Loop)
```

---

## 🎮 Estado da Bolinha e Física

```
         ESTADO DA BOLINHA
         
┌────────────────────────────────┐
│  Position: (x, y)              │
│  Velocity: (vx, vy)            │
│  Acceleration: (ax, ay)        │
└────────────────────────────────┘
              │
              ▼
    ┌─────────────────────┐
    │  MPU6050 Reading    │
    │  tilt_x, tilt_y     │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │  ax = tilt_x * k    │
    │  ay = tilt_y * k    │
    │  k = TILT_SCALE     │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │  vx += ax * dt      │
    │  vy += ay * dt      │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │  Apply Friction     │
    │  vx *= FRICTION     │
    │  vy *= FRICTION     │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │  Limit Velocity     │
    │  if v > MAX_V then  │
    │    v = MAX_V        │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │  x += vx * dt       │
    │  y += vy * dt       │
    └──────────┬──────────┘
               │
               ▼
    ┌─────────────────────┐
    │  Collision Check    │
    │  (8 points around)  │
    └──────────┬──────────┘
               │
          ┌────┴────┐
          │         │
     ┌────▼────┐ ┌──▼──────┐
     │ Hit Wall│ │   OK    │
     └────┬────┘ └──┬──────┘
          │         │
          ▼         ▼
     ┌────────┐ ┌─────────┐
     │Bounce  │ │ Update  │
     │vx*=-0.3│ │Position │
     │vy*=-0.3│ └─────────┘
     └────────┘
```

---

## 🗺️ Estrutura do Labirinto

```
Labirinto 16x16 células

┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐
│█│█│█│█│█│█│█│█│█│█│█│█│█│█│█│█│ Y=0  (Parede)
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│S│ │ │█│ │ │ │ │ │ │ │ │ │ │█│ Y=1  S=Start
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │█│ │█│ │█│█│█│█│█│█│█│█│ │█│ Y=2
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │█│ │ │ │ │ │ │ │ │ │ │█│ │█│ Y=3
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │█│█│█│█│█│█│█│█│█│█│ │█│ │█│ Y=4
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │ │ │ │ │ │●│ │ │ │█│ │█│ │█│ Y=5  ●=Hole
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│█│█│█│█│█│ │█│█│█│ │█│ │█│ │█│ Y=6
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │ │ │ │ │ │█│ │ │ │█│ │ │ │█│ Y=7
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │█│█│█│█│█│█│ │█│█│█│█│█│ │█│ Y=8
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │ │●│ │ │ │ │ │ │ │ │ │█│ │█│ Y=9  ●=Hole
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│█│█│█│█│█│ │█│█│█│█│█│ │█│ │█│ Y=10
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │ │ │ │ │ │ │ │●│ │ │ │█│ │█│ Y=11 ●=Hole
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │█│█│█│█│█│█│█│█│█│█│█│█│ │█│ Y=12
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │ │ │ │ │ │ │ │ │ │ │ │ │ │█│ Y=13
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│ │█│█│█│█│█│█│█│█│█│█│█│█│G│█│ Y=14 G=Goal
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│█│█│█│█│█│█│█│█│█│█│█│█│█│█│█│█│ Y=15 (Parede)
└─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘
 X=0                           X=15

Legenda:
█ = Parede (CELL_WALL = 1)
  = Vazio (CELL_EMPTY = 0)
● = Buraco (CELL_HOLE = 2)
S = Início (1,1)
G = Objetivo (CELL_GOAL = 3) (14,14)

Mapeamento pixel:
Célula (X,Y) → Pixel (X*14+8, Y*14+20)
CELL_SIZE = 14 pixels
MAZE_OFFSET_X = 8 pixels
MAZE_OFFSET_Y = 20 pixels
```

---

## 📡 Comunicação entre Tasks

```
┌──────────────┐
│   IMU_Task   │
│   Priority 3 │
│   (Highest)  │
└──────┬───────┘
       │
       │ xQueueSend()
       │
       ▼
┌──────────────────┐
│   imu_queue      │
│  (5 elements)    │
│  mpu6050_raw_t   │
└──────┬───────────┘
       │
       │ xQueueReceive()
       │
       ▼
┌──────────────────┐
│ GameLogic_Task   │
│   Priority 2     │
│   (Medium)       │
└──────┬───────────┘
       │
       │ Updates global state:
       │ • ball position
       │ • game_state
       │ • lives
       │ • game_time_ms
       │
       ▼
┌──────────────────┐
│ display_mutex    │
│ (Semaphore)      │
└──────┬───────────┘
       │
       │ xSemaphoreTake()
       │
       ▼
┌──────────────────┐
│  Display_Task    │
│   Priority 1     │
│   (Lowest)       │
│                  │
│  Reads:          │
│  • ball          │
│  • game_state    │
│  • lives         │
│  • game_time_ms  │
└──────────────────┘

┌──────────────────┐
│  Button_Task     │
│   Priority 1     │
└──────┬───────────┘
       │
       │ Sets flag:
       │ button_pressed
       │
       ▼
┌──────────────────┐
│ GameLogic_Task   │
│ (reads flag)     │
└──────────────────┘
```

---

## 🔌 Conexões de Hardware (Pinout)

```
                    STM32F411 (Black Pill)
                    ┌───────────────────┐
                    │                   │
          ┌─────────┤ PA0  (Button)    │
          │         │                   │
  BUTTON──┴─────────┤ GND              │
                    │                   │
          ┌─────────┤ PA2  (USART2_TX) ├─────┐
          │         │                   │     │
          │    ┌────┤ PA3  (USART2_RX) ├──┐  │  UART Debug
          │    │    │                   │  │  │
          │    │    │ PA4  (SPI1_CS)   ├──┼──┼──┐
          │    │    │                   │  │  │  │
          │    │    │ PA5  (SPI1_SCK)  ├──┼──┼──┼──┐
          │    │    │                   │  │  │  │  │
          │    │    │ PA7  (SPI1_MOSI) ├──┼──┼──┼──┼──┐
          │    │    │                   │  │  │  │  │  │
          │    │    │ PB0  (ST7789_RES)├──┼──┼──┼──┼──┼──┐
          │    │    │                   │  │  │  │  │  │  │
          │    │    │ PB1  (ST7789_DC) ├──┼──┼──┼──┼──┼──┼──┐
          │    │    │                   │  │  │  │  │  │  │  │
          │    │    │ PB8  (I2C1_SCL)  ├──┼──┼──┼──┼──┼──┼──┼──┐
          │    │    │                   │  │  │  │  │  │  │  │  │
          │    │    │ PB9  (I2C1_SDA)  ├──┼──┼──┼──┼──┼──┼──┼──┼──┐
          │    │    │                   │  │  │  │  │  │  │  │  │  │
          │    │    │ 3.3V             ├──┼──┼──┼──┼──┼──┼──┼──┼──┼─┐
          │    │    │                   │  │  │  │  │  │  │  │  │  │ │
          │    │    │ GND              ├──┼──┼──┼──┼──┼──┼──┼──┼──┼─┼─┐
          │    │    └───────────────────┘  │  │  │  │  │  │  │  │  │ │ │
          │    │                           │  │  │  │  │  │  │  │  │ │ │
          │    └───────────────────────────┘  │  │  │  │  │  │  │  │ │ │
          │                                   │  │  │  │  │  │  │  │ │ │
          └───────────────────────────────────┘  │  │  │  │  │  │  │ │ │
                                                 │  │  │  │  │  │  │ │ │
┌──────────────────────────────────────────────┐ │  │  │  │  │  │  │ │ │
│                ST7789 Display                 │ │  │  │  │  │  │  │ │ │
├───────────────────────────────────────────────┤ │  │  │  │  │  │  │ │ │
│ CS  ◄─────────────────────────────────────────┼─┘  │  │  │  │  │  │ │ │
│ SCL ◄─────────────────────────────────────────┼────┘  │  │  │  │  │ │ │
│ SDA ◄─────────────────────────────────────────┼───────┘  │  │  │  │ │ │
│ RES ◄─────────────────────────────────────────┼──────────┘  │  │  │ │ │
│ DC  ◄─────────────────────────────────────────┼─────────────┘  │  │ │ │
│ VCC ◄─────────────────────────────────────────┼────────────────┘  │ │ │
│ BLK ◄─────────────────────────────────────────┼───────────────────┘ │ │
│ GND ◄─────────────────────────────────────────┼─────────────────────┘ │
└───────────────────────────────────────────────┘                       │
                                                                         │
┌──────────────────────────────────────────────┐                        │
│                 MPU6050 IMU                   │                        │
├───────────────────────────────────────────────┤                        │
│ SCL ◄─────────────────────────────────────────┼────────────────────────┤
│ SDA ◄─────────────────────────────────────────┼─────────────────────┐  │
│ VCC ◄─────────────────────────────────────────┼─────────────────┐   │  │
│ GND ◄─────────────────────────────────────────┼──────────────┐  │   │  │
│ AD0 ◄─────────────────────────────────────────┼───────────┐  │  │   │  │
└───────────────────────────────────────────────┘           │  │  │   │  │
                                                            │  │  │   │  │
                                                            │  │  3.3V│  │
                                                            │  GND    │  │
                                                            GND       │  │
                                                                   I2C1_SDA
                                                                   I2C1_SCL
```

---

## ⏱️ Timing Diagram

```
Time (ms) →

IMU_Task (50Hz):
|─20ms─|─20ms─|─20ms─|─20ms─|─20ms─|
▼      ▼      ▼      ▼      ▼      ▼
Read   Read   Read   Read   Read   Read
MPU    MPU    MPU    MPU    MPU    MPU

GameLogic_Task (50Hz):
|─20ms─|─20ms─|─20ms─|─20ms─|─20ms─|
▼      ▼      ▼      ▼      ▼      ▼
Phys   Phys   Phys   Phys   Phys   Phys
Logic  Logic  Logic  Logic  Logic  Logic

Display_Task (20Hz):
|───────50ms────────|───────50ms────────|
▼                   ▼                   ▼
Render              Render              Render
Frame               Frame               Frame

Button_Task (50Hz):
|─20ms─|─20ms─|─20ms─|─20ms─|─20ms─|
▼      ▼      ▼      ▼      ▼      ▼
Check  Check  Check  Check  Check  Check
Btn    Btn    Btn    Btn    Btn    Btn

Jogo completo: ~50 FPS (física) + 20 FPS (display)
```

---

## 🎯 Fluxo de Detecção de Colisão

```
         Ball Position (x, y)
                │
                ▼
    ┌───────────────────────┐
    │ Check 8 points around │
    │ ball at BALL_RADIUS   │
    └───────────┬───────────┘
                │
                ▼
        For angle = 0° to 315° (step 45°):
        
    0°(N)    45°(NE)   90°(E)   135°(SE)
        ╲      │      ╱
         ╲     │     ╱
          ╲    │    ╱
       315° ───●─── 45°        ● = Ball center
          ╱    │    ╲
         ╱     │     ╲
        ╱      │      ╲
  270°(W)   225°(SW)  180°(S)

        check_x = x + cos(angle) * BALL_RADIUS
        check_y = y + sin(angle) * BALL_RADIUS
                │
                ▼
    ┌───────────────────────┐
    │ Convert to cell coord │
    │ cell_x = (check_x - OFFSET_X) / CELL_SIZE │
    │ cell_y = (check_y - OFFSET_Y) / CELL_SIZE │
    └───────────┬───────────┘
                │
                ▼
    ┌───────────────────────┐
    │ Get cell type from    │
    │ maze_map[cell_y][cell_x] │
    └───────────┬───────────┘
                │
         ┌──────┴──────┐
         │             │
    ┌────▼────┐   ┌────▼────┐
    │ WALL?   │   │ OTHER?  │
    └────┬────┘   └────┬────┘
         │             │
        YES           NO
         │             │
         ▼             ▼
   ┌─────────┐   ┌─────────┐
   │COLLISION│   │   OK    │
   │Bounce   │   │Continue │
   │back     │   └─────────┘
   └─────────┘
```

---

Estes diagramas ajudam a visualizar a arquitetura e o fluxo do sistema!
